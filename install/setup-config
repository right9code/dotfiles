#!/bin/bash

# 'set -e' ensures that the script exits immediately if any command returns a non-zero exit status (error).
# This is a safety feature to prevent the script from continuing execution in an unstable state.
set -e

# Determine the absolute path of the directory where this script is currently located.
# 'cd --' ensures we handle directory names starting with '-' correctly.
# 'dirname -- "${BASH_SOURCE[0]}"' gets the directory name of the current script.
# '&>/dev/null' suppresses output during the cd command.
# 'pwd' prints the working directory.
SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )

# Source (import) external helper scripts.
# 'helpers.sh' contains utility functions like logging and UI elements.
source "$SCRIPT_DIR/lib/helpers.sh"
# 'backup.sh' contains functions to handle backing up existing files before overwriting.
source "$SCRIPT_DIR/lib/backup.sh"

# Define the root directory of the dotfiles repository.
DOTFILES_DIR="$HOME/.local/share/dotfiles"

log_info "Backing up existing config..."

# --- Identify Targets ---

# Initialize an empty array to store the paths of files/directories we plan to replace.
TARGETS=()

# Loop through every item (file or directory) in the dotfiles 'config' folder.
for item in "$DOTFILES_DIR/config"/*; do
  # Check if the item actually exists (sanity check).
  if [ -e "$item" ]; then
    # Get the base name of the item (e.g., 'hypr', 'waybar').
    item_name=$(basename "$item")
    # Construct the target path in the user's local config directory (~/.config/hypr).
    TARGETS+=("$HOME/.config/$item_name")
  fi
done

# --- Backup Phase ---

# Loop through the list of target paths we identified.
for target in "${TARGETS[@]}"; do
  # Check if a file or directory already exists at the target location.
  if [ -e "$target" ]; then
    # If it exists, back it up using the 'backup_file' function.
    # This moves it to the backup directory and records the restore command.
    backup_file "$target" || {
      log_error "Failed to backup $(basename "$target")"
      exit 1
    }
  fi
done

# --- Cleanup Phase ---

# Loop through the targets again to remove the old versions.
# We do this in a separate loop after backing up everything to ensure all backups succeed before we start deleting.
for target in "${TARGETS[@]}"; do
  remove_path "$target"
done


# --- Installation Phase ---

# Copy all configuration files from the dotfiles repo to ~/.config/.
# We use 'cp -r' (recursive copy) instead of symlinking.
# This means changes in ~/.config won't automatically update the repo.
cp -r "$DOTFILES_DIR/config/"* "$HOME/.config/"
log_success "Config copied!"

# --- GTK Theme Configuration ---

# Create/Overwrite the GTK 3.0 CSS file to import the dynamic theme file.
# This allows the GTK theme to change when the system theme changes (via the 'current/theme' symlink).
echo "@import url(\"file://$HOME/.local/share/dotfiles/current/theme/gtk.css\");" > "$HOME/.config/gtk-3.0/gtk.css"

# Do the same for GTK 4.0.
echo "@import url(\"file://$HOME/.local/share/dotfiles/current/theme/gtk.css\");" > "$HOME/.config/gtk-4.0/gtk.css"

log_success "Config copied!"
log_info "Backup saved to: $BACKUP_DIR"
log_info "Restore instructions: cat $RESTORE_FILE"
